# リリースノート - v0.4.0

> **開発版リリース**
> バックエンドAPI統合とパフォーマンス最適化を完了しました。
> **利用職種**: PdM, PMM, TechLead

---

## リリース情報
- **バージョン**: v0.4.0
- **リリース日**: 2026/01/26
- **リリースタイプ**: Minor（開発版）
- **対象プラン**: すべてのユーザー

---

## 🚀 新機能 (New Features)

### クラウド同期対応

**概要**:
作成した小説とチャプターがクラウドに自動保存されるようになりました。複数のデバイスからアクセスできます。

**変更内容**:
- ローカルストレージ（IndexedDB）からCloudflare D1への移行
- 自動保存機能の改善（3秒後に自動保存）
- 複数デバイスでの同時編集準備

**メリット**:
- データの永続化（ブラウザキャッシュクリア時も安全）
- 複数デバイスからのアクセス
- 将来的なコラボレーション機能の基盤

**対象ユーザー**: すべてのユーザー

---

### Google認証によるログイン

**概要**:
Googleアカウントでログインできるようになりました。

**使い方**:
1. トップページの「ログイン」ボタンをクリック
2. Googleアカウントを選択
3. 認証を許可

**対象ユーザー**: すべてのユーザー

---

## ✨ 改善 (Improvements)

### パフォーマンス

#### ページ読み込み速度の大幅向上（91%削減）

**トップページ**:
- 初期ロードJavaScriptを**91%削減**（165KB → 15KB）
- First Contentful Paint（FCP）が**30-50%改善**
- 小説カードが即座に表示される（JavaScriptなし）

**技術的な改善**:
- Astroアイランドアーキテクチャの導入
- 必要な部分だけをインタラクティブに（`client:idle`, `client:visible`）
- 静的HTMLによる即座の表示

**ユーザーへの影響**:
- モバイル環境での読み込みが大幅に高速化
- 低速なネットワークでも快適に利用可能
- 帯域幅の節約（従量課金のモバイルユーザーに優しい）

#### エディタ初期化の最適化

**改善内容**:
- `setTimeout`によるパフォーマンス警告を解消
- Svelteの`tick()`を使用した堅牢なDOM待機
- リトライロジックによるエラーハンドリング強化

**ユーザーへの影響**:
- エディタの起動が安定
- エラーが発生しにくくなった

---

### UI/UX

#### サーバーサイドレンダリング（SSR）による高速化

**改善内容**:
- ページがサーバー側で生成されるため、初期表示が高速
- SEOの改善（検索エンジンにインデックスされやすくなった）

**対象ページ**:
- マイ小説一覧
- エディタページ
- 小説詳細ページ

---

## 🔧 技術的な変更 (Technical Changes)

### バックエンド

#### Cloudflare Workers + D1 API実装

**実装したAPI**:
- **認証API**: Google OAuth、セッション管理
- **小説API**: CRUD操作、公開/非公開管理
- **チャプターAPI**: CRUD操作、チャプター番号管理

**エンドポイント**:
```
- GET /v1/novels - 公開小説一覧
- GET /v1/novels/mine - マイ小説一覧
- POST /v1/novels - 小説作成
- GET /v1/chapters/:id - チャプター取得
- PUT /v1/chapters/:id - チャプター更新
```

**技術スタック**:
- Hono（Webフレームワーク）
- Drizzle ORM（データベースアクセス）
- Lucia Auth（認証）
- Arctic（Google OAuth）

---

### フロントエンド

#### アイランドアーキテクチャの実装

**コンポーネント分類**:

| コンポーネント | ハイドレーション戦略 | JavaScript |
|--------------|-------------------|-----------|
| Header | `client:idle`（アイドル時） | 15KB（遅延） |
| NovelCard | 静的HTML | 0KB |
| TiptapEditor | `client:load`（即座） | 200KB |
| StatsDashboard | `client:visible`（表示時） | 50KB（遅延） |

**効果**:
- トップページの初期ロード: 165KB → 15KB（91%削減）
- First Contentful Paint: 30-50%改善

#### APIクライアント実装

**主要機能**:
- クライアントサイド・サーバーサイド両対応
- 型安全なAPIラッパー
- エラーハンドリング
- サーバーサイド用ヘルパー関数（クッキー転送）

**実装ファイル**:
- `app/src/lib/api/client.ts` - 基盤
- `app/src/lib/api/auth.ts` - 認証API
- `app/src/lib/api/novels.ts` - 小説API
- `app/src/lib/api/chapters.ts` - チャプターAPI

---

## 🐛 バグ修正 (Bug Fixes)

### Tiptapエディタの空コンテンツエラー修正

**問題**:
- 新規チャプター作成時に`RangeError: Unknown node type: undefined`が発生

**原因**:
- 空のJSON `'{}'`を渡していた

**修正**:
- 正しいTiptap構造を使用（`{ type: 'doc', content: [] }`）

---

### setTimeout パフォーマンス警告の解消

**問題**:
- `[Violation] 'setTimeout' handler took 57ms`警告が発生

**原因**:
- エディタ初期化でDOM待機にsetTimeoutを使用

**修正**:
- Svelteの`tick()`を使用した堅牢な待機ロジック

---

## 📋 既知の問題 (Known Issues)

### データ移行

**状況**:
- IndexedDBコードを削除しました（v0.4.0）
- 旧データはCloudflare D1に移行済み

**注意事項**:
- v0.3.x以前のローカルデータは利用できません
- 新しいアカウントでログインしてください

---

## 🔮 次のバージョン予定 (Next Release)

### v0.5.0 - Phase 6: データ移行・テスト（予定）

**計画中の機能**:
- [ ] IndexedDB → D1 データ移行ツール（オプション）
- [ ] 手動テスト完了（認証、CRUD、エディタ）
- [ ] E2Eテスト（Playwright、オプション）
- [ ] 旧IndexedDBコード削除または無効化

### v0.6.0 - Phase 7: コメント機能（予定）

**計画中の機能**:
- [ ] チャプターへのコメント機能
- [ ] リアルタイム更新
- [ ] 通知システム

---

## 📚 ドキュメント更新

### 新規作成
- `52.05_ADR_Islands_Architecture_Performance.md` - アイランドアーキテクチャADR
- `53.02_Implementation_Tasks_API_Integration.md` - API統合実装タスク

### 更新
- `51.01_TechSpec_Frontend.md` - フロントエンド技術仕様（Svelte + API統合）
- `51.01_TechSpec_Backend.md` - バックエンド技術仕様（Cloudflare Workers + D1）

---

## 🙏 謝辞

この実装では以下の技術を活用しました：
- [Astro](https://astro.build/) - アイランドアーキテクチャ
- [Svelte](https://svelte.dev/) - リアクティブコンポーネント
- [Cloudflare Workers](https://workers.cloudflare.com/) - サーバーレス実行環境
- [Cloudflare D1](https://developers.cloudflare.com/d1/) - サーバーレスデータベース
- [Tiptap](https://tiptap.dev/) - リッチテキストエディタ
- [Lucia Auth](https://lucia-auth.com/) - 認証ライブラリ

---

## 🔗 関連リンク

- [技術仕様書: フロントエンド](../../50_Engineering_Tech/51.01_TechSpec_Frontend.md)
- [技術仕様書: バックエンド](../../50_Engineering_Tech/51.01_TechSpec_Backend.md)
- [ADR: アイランドアーキテクチャ](../../50_Engineering_Tech/52.05_ADR_Islands_Architecture_Performance.md)
- [実装タスク: API統合](../../50_Engineering_Tech/53.02_Implementation_Tasks_API_Integration.md)

---

**変更履歴**

| 日付 | 変更者 | 変更内容 |
| --- | --- | --- |
| 2026-01-26 | Claude | v0.4.0リリースノート作成 |
