# ADR-005: アイランドアーキテクチャによるパフォーマンス最適化

**日付**: 2026-01-26
**ステータス**: 採用済み
**決定者**: 開発チーム
**関連文書**: `51.01_TechSpec_Frontend.md`, `51.01_TechSpec_Architecture.md`

---

## コンテキスト (Context)

AstraNote では、以下の課題がありました：

1. **初期ロードパフォーマンス**: すべてのSvelteコンポーネントが`client:load`でロードされ、不要なJavaScriptが初期ロード時に配信されていた
2. **First Contentful Paint (FCP)の遅延**: インタラクティブでない要素（NovelCard、静的テキスト）もJavaScriptを必要としていた
3. **帯域幅の無駄**: ユーザーが見ない/使わないコンポーネントのJavaScriptまでロードされていた

### 問題の具体例

```astro
<!-- 最適化前 -->
<Header client:load />           <!-- 15KB JS、即座にロード -->
<NovelCard client:load />        <!-- 5KB JS × 20枚 = 100KB、即座にロード -->
<StatsDashboard client:load />  <!-- 50KB JS、スクロールしないと見えない -->

合計初期ロード: 165KB JavaScript
```

---

## 決定内容 (Decision)

Astro 5のアイランドアーキテクチャを活用し、以下のハイドレーション戦略を採用する：

### 1. コンポーネント分類とディレクティブ選択

| コンポーネント | ディレクティブ | 理由 |
|--------------|--------------|------|
| **Header** | `client:idle` | インタラクティブだが、即座でなくてもOK（認証状態、テーマ切り替え） |
| **NovelCard** | なし（静的HTML） | リンクのみ、JavaScript不要 |
| **TiptapEditor** | `client:load` | エディタの中核、即座の読み込みが必要 |
| **ChapterList** | `client:load` | エディタの中核、即座の読み込みが必要 |
| **StatsDashboard** | `client:visible` | スクロールで表示されるまで遅延 |

### 2. 実装パターン

#### パターンA: ブラウザアイドル時ロード（`client:idle`）
**用途**: 重要だが即座でなくてもいいインタラクティブ要素

```astro
<!-- ヘッダー: 認証状態、ナビゲーション、テーマ切り替え -->
<Header client:idle />
```

**効果**:
- First Contentful Paint後にロード
- メインコンテンツの表示を妨げない
- ブラウザがアイドル状態になってから実行

#### パターンB: 画面表示時ロード（`client:visible`）
**用途**: スクロールで見える重いコンポーネント

```astro
<!-- 統計ダッシュボード: グラフ、チャート -->
<StatsDashboard client:visible />
```

**効果**:
- IntersectionObserverで検出
- 画面に表示されるまでJavaScriptをロードしない
- 大きなチャートライブラリの遅延ロード

#### パターンC: 静的HTML（ディレクティブなし）
**用途**: インタラクションがない表示専用コンポーネント

```astro
<!-- 小説カード: タイトル、説明、リンク -->
<NovelCard novel={novel} />
```

**効果**:
- JavaScriptなし（0KB）
- HTMLとCSSのみで表示
- リンクは通常のHTMLアンカーとして機能

---

## 結果 (Consequences)

### メリット

1. **初期ロードパフォーマンス向上**
   ```
   【最適化前】165KB JavaScript（即座にロード）
   【最適化後】0KB JavaScript（初期）+ 15KB（アイドル時）
   削減率: 91%（初期ロード時）
   ```

2. **First Contentful Paint (FCP) 改善**
   - 静的HTMLが即座に表示
   - JavaScriptのパース・実行を待たない
   - Lighthouseスコア向上

3. **ユーザー体験の向上**
   - コンテンツが即座に見える
   - インタラクション可能になるまでの時間短縮
   - モバイル環境での恩恵が大きい

4. **帯域幅の削減**
   - 使わない機能のJavaScriptをロードしない
   - 従量課金のモバイルユーザーに優しい

### デメリット・トレードオフ

1. **開発時の判断が必要**
   - 各コンポーネントに適切なディレクティブを選択する必要がある
   - 誤った選択はユーザー体験を損なう可能性

2. **テストの複雑化**
   - ハイドレーションのタイミングを考慮したテストが必要
   - `client:visible`は実際のスクロールが必要

3. **デバッグの難しさ**
   - ハイドレーションエラーが発生する可能性
   - サーバーサイドとクライアントサイドで異なる動作

### リスクと対策

| リスク | 対策 |
|--------|------|
| ハイドレーションエラー | Svelteの`tick()`を使用したDOM待機、リトライロジック実装済み |
| 過度な遅延ロードによるUX低下 | エディタなど重要なコンポーネントは`client:load`を維持 |
| 開発者の理解不足 | 本ADRとコメントで明確に記載、コードレビューで確認 |

---

## 実装状況

### Phase 1: 完了（2026-01-26）

- ✅ Header: `client:idle`に変更
- ✅ NovelCard: 静的HTMLに変更
- ✅ StatsDashboard: `client:visible`に変更
- ✅ TiptapEditor: `client:load`を維持（エディタの中核）
- ✅ ChapterList: `client:load`を維持（エディタの中核）

### 測定結果

```
トップページ（http://localhost:4321/）
├─ 最適化前: 165KB JavaScript（初期ロード）
└─ 最適化後: 0KB JavaScript（初期）+ 15KB（アイドル時）

削減量: 150KB（91%削減）
FCP改善: 推定30-50%
```

---

## 関連決定

- **ADR-001**: 技術スタック選定（Astro + Svelte）
- **ADR-003**: Cloudflare Workers + D1によるバックエンド構成

---

## 参照

- [Astro Islands Documentation](https://docs.astro.build/en/concepts/islands/)
- [Astro Client Directives](https://docs.astro.build/en/reference/directives-reference/#client-directives)
- [Web Vitals - First Contentful Paint](https://web.dev/fcp/)
