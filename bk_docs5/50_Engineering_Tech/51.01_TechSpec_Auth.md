# 技術仕様書：認証・認可

> **テンプレート利用ガイド**
> 認証・認可システムの詳細設計書です。
> **利用職種**: Security Engineer, Backend Engineer

---

## 1. 概要 (Overview)
**Arctic OAuth 2.0ライブラリ**と**カスタムSessionManager**を使用してセキュアで柔軟な認証システムを構築する。
Cloudflare D1にセッション情報を保存し、HttpOnly CookieでセッションIDを管理する。

### 使用技術
- **OAuth処理**: [Arctic](https://arcticjs.dev/) v3.7.0 - OAuth 2.0 clients for popular providers
- **セッション管理**: カスタムSessionManagerクラス (Drizzle ORM + Cloudflare D1)
- **データベース**: Cloudflare D1 (SQLite互換)
- **フレームワーク**: Hono

---

## 2. 認証方式
- **セッションベース認証**: D1 + Cookie (HttpOnly, Secure)
- **OAuth 2.0 ログイン**: Google (PKCE フロー)
  - 将来的にGitHub、Discord等も対応可能
- **Email/Password**: 現在未実装（将来的にArgon2idでハッシュ化）

---

## 3. 認証フロー

### 3.1 Google OAuth フロー (PKCE)

1. **認証開始** (`GET /v1/auth/google`)
   - Arcticを使用してGoogle認証URLを生成
   - PKCE用のCode VerifierとStateを生成
   - 一時Cookie（10分TTL）に保存
   - Googleの認証画面にリダイレクト

2. **コールバック処理** (`GET /v1/auth/google/callback`)
   - State検証（CSRF対策）
   - 認証コードをアクセストークンに交換
   - Google APIでユーザー情報取得
   - `oauth_accounts`テーブルで既存ユーザー確認
   - 新規ユーザーの場合: `users`テーブルに作成
   - SessionManagerでセッション作成
   - セッションCookie（30日TTL）を設定
   - フロントエンドにリダイレクト

3. **リクエスト検証**
   - Middlewareで`auth_session` Cookieからセッション検証
   - SessionManagerで有効性確認
   - 期限切れセッションは自動削除

4. **Context設定**
   - HonoのContextにユーザー情報を注入 (`c.set('user', user)`)
   - 認証必須エンドポイントで利用

### 3.2 セッション管理

**SessionManager** (`/backend/src/lib/session.ts`)

| メソッド | 説明 |
|---------|------|
| `generateSessionId()` | 32バイトランダムID生成（hex） |
| `createSession(userId)` | 新規セッション作成（30日TTL） |
| `validateSession(sessionId)` | セッション検証＆ユーザー取得 |
| `deleteSession(sessionId)` | セッション削除（ログアウト） |
| `deleteUserSessions(userId)` | ユーザーの全セッション削除 |
| `cleanupExpiredSessions()` | 期限切れセッション一括削除 |

---

## 4. 権限管理 (Roles)
| ロール | 権限 |
| ------ | ---- |
| **Guest** | 小説閲覧（一部制限）、ログイン |
| **Reader** | 閲覧、ブックマーク、コメント、フォロー |
| **Writer** | Reader権限 + 作品作成・編集・公開 |
| **Admin** | システム管理、ユーザー管理、コンテンツ削除 |

---

## 5. セキュリティ対策

### 5.1 OAuth セキュリティ
- **PKCE フロー**: Code Verifier + Code Challenge（公開クライアント向け）
- **State検証**: CSRF攻撃防止（ランダム文字列の一致確認）
- **一時Cookie**: State/Verifier用の短命Cookie（10分TTL）

### 5.2 セッションセキュリティ
- **HttpOnly Cookie**: スクリプトからのアクセス防止
- **Secure フラグ**: HTTPS-only（本番環境）
- **SameSite=Lax**: CSRF攻撃緩和
- **セッション有効期限**: 30日（自動期限切れ削除）

### 5.3 データベースセキュリティ
- **パスワードハッシュ化**: Argon2id推奨（実装予定）
- **セッションID**: 暗号学的に安全な乱数生成
- **CASCADE削除**: ユーザー削除時にセッション・OAuth情報も自動削除

### 5.4 その他のセキュリティ対策
- **CSRF対策**: HonoのCSRFミドルウェア（実装予定）
- **Rate Limiting**: ログイン試行制限（実装予定）
- **定期クリーンアップ**: 期限切れセッションの自動削除

---

## 6. データベーススキーマ

### 6.1 users テーブル
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,           -- UUID v4
  email TEXT NOT NULL UNIQUE,
  username TEXT NOT NULL UNIQUE,
  display_name TEXT,
  avatar_url TEXT,
  role TEXT NOT NULL DEFAULT 'writer',  -- reader, writer, admin
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

### 6.2 sessions テーブル
```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,           -- 32バイト hex
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  expires_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL
);

CREATE INDEX sessions_user_id_idx ON sessions(user_id);
CREATE INDEX sessions_expires_at_idx ON sessions(expires_at);
```

### 6.3 oauth_accounts テーブル
```sql
CREATE TABLE oauth_accounts (
  provider_id TEXT NOT NULL,      -- 'google', 'github', etc.
  provider_user_id TEXT NOT NULL, -- プロバイダー側のユーザーID
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at INTEGER NOT NULL,
  PRIMARY KEY (provider_id, provider_user_id)
);

CREATE INDEX oauth_accounts_user_id_idx ON oauth_accounts(user_id);
```

---

## 7. API エンドポイント

| エンドポイント | メソッド | 認証 | 説明 |
|-------------|--------|------|------|
| `/v1/auth/google` | GET | 不要 | Google OAuth開始 |
| `/v1/auth/google/callback` | GET | 不要 | OAuth コールバック |
| `/v1/auth/logout` | POST | 必須 | ログアウト |
| `/v1/auth/me` | GET | 必須 | 現在のユーザー情報取得 |
| `/v1/auth/test-login` | POST | 不要 | テスト用ログイン（開発環境のみ） |

---

## 8. 環境変数

```toml
# wrangler.toml
[vars]
ENVIRONMENT = "development"
FRONTEND_URL = "http://localhost:4321"

# シークレット（実行時）
GOOGLE_CLIENT_ID = "..."
GOOGLE_CLIENT_SECRET = "..."
```

---

## 関連ドキュメント
- [51.01_TechSpec_Backend.md](51.01_TechSpec_Backend.md)
- [Arctic Documentation](https://arcticjs.dev/)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
