---
title: システムアーキテクチャ
description: Star Novel の技術アーキテクチャ設計（コスト最適化版）
---

## 概要

Star Novelのシステムアーキテクチャの全体像を定義します。**維持費を最小限に抑えながら**、スケーラビリティと開発速度を両立する設計です。

:::note[設計方針]
- **コストファースト**: 無料枠・低コストサービスを最大活用
- **Cloudflare統一**: 一つのプラットフォームで完結させコスト削減
- **段階的スケール**: 必要になってから有料プランへ移行
:::

---

## コスト比較サマリー

### 従来設計 vs 最適化設計

| 項目 | 従来設計 | 最適化設計 | 削減率 |
|------|---------|-----------|--------|
| Phase 1 月額 | ~$160 | **~$15** | **90%減** |
| Phase 2 月額 | ~$500 | **~$80** | **84%減** |
| Phase 3 月額 | ~$1,500 | **~$300** | **80%減** |

---

## アーキテクチャ概要

### 全体構成（Cloudflare統一アーキテクチャ）

```
┌─────────────────────────────────────────────────────────────────────┐
│              Star Novel Architecture (Cost-Optimized)                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│  │   読者      │     │   作家      │     │   管理者    │          │
│  │  (Web/PWA)  │     │  (Web)      │     │  (Web)      │          │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘          │
│         │                   │                   │                  │
│         └───────────────────┼───────────────────┘                  │
│                             │                                      │
│                             ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                  Cloudflare (すべて無料枠)                   │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │  CDN + DDoS Protection + SSL (自動)                 │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                             │                                │  │
│  │                             ▼                                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │  Cloudflare Pages (Frontend)                        │    │  │
│  │  │  - Next.js / SvelteKit / Astro                      │    │  │
│  │  │  - 無料: 500ビルド/月、無制限リクエスト             │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                             │                                │  │
│  │                             ▼                                │  │
│  │  ┌─────────────────────────────────────────────────────┐    │  │
│  │  │  Cloudflare Workers (Backend API)                   │    │  │
│  │  │  - Hono Framework                                   │    │  │
│  │  │  - 無料: 100,000リクエスト/日                       │    │  │
│  │  └─────────────────────────────────────────────────────┘    │  │
│  │                             │                                │  │
│  │         ┌───────────────────┼───────────────────┐           │  │
│  │         │                   │                   │           │  │
│  │         ▼                   ▼                   ▼           │  │
│  │  ┌───────────┐       ┌───────────┐       ┌───────────┐     │  │
│  │  │    D1     │       │    KV     │       │    R2     │     │  │
│  │  │(SQLite)   │       │ (Cache)   │       │ (Storage) │     │  │
│  │  │無料:5GB   │       │無料:100K  │       │無料:10GB  │     │  │
│  │  └───────────┘       └───────────┘       └───────────┘     │  │
│  │                                                              │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│                             │                                      │
│                             ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │              Translation Service (コスト最適化)              │  │
│  │                                                              │  │
│  │  優先順位:                                                   │  │
│  │  1. Gemini 2.0 Flash  ($0.10/1M tokens) ← 最安              │  │
│  │  2. Claude 3.5 Haiku  ($0.25/1M tokens) ← 高品質            │  │
│  │  3. DeepL API Free    (500K文字/月無料) ← バックアップ      │  │
│  │                                                              │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 技術スタック（コスト最適化版）

### フロントエンド

| カテゴリ | 技術 | 理由 | 月額コスト |
|---------|------|------|-----------|
| フレームワーク | **Astro** または SvelteKit | 軽量、静的生成優先 | $0 |
| 言語 | TypeScript | 型安全 | $0 |
| スタイリング | Tailwind CSS | 軽量 | $0 |
| UIライブラリ | shadcn/ui | 軽量、カスタマイズ可 | $0 |
| 状態管理 | nanostores | 超軽量 | $0 |
| ホスティング | **Cloudflare Pages** | 無料、高速 | **$0** |

:::tip[Vercel vs Cloudflare Pages]
| 項目 | Vercel (Pro) | Cloudflare Pages |
|------|-------------|------------------|
| 月額 | $20 | **$0** |
| ビルド | 6000分/月 | 500回/月 |
| 帯域 | 1TB | **無制限** |
| Edge Functions | 有料 | **無料** |
:::

### バックエンド

| カテゴリ | 技術 | 理由 | 月額コスト |
|---------|------|------|-----------|
| ランタイム | Cloudflare Workers | 無料枠大 | $0 |
| フレームワーク | Hono | 軽量、Workers最適 | $0 |
| ORM | Drizzle | D1対応、軽量 | $0 |
| 認証 | Lucia Auth | Workers対応 | $0 |
| バリデーション | Zod | 軽量 | $0 |

### データベース・ストレージ

| カテゴリ | 技術 | 無料枠 | 月額コスト |
|---------|------|-------|-----------|
| メインDB | **Cloudflare D1** | 5GB、5M reads/日 | **$0** |
| キャッシュ | Cloudflare KV | 100K reads/日 | $0 |
| ストレージ | Cloudflare R2 | 10GB、1M reads/月 | $0 |
| 全文検索 | **D1 FTS5** | SQLite組込 | **$0** |

:::note[Turso vs D1]
| 項目 | Turso (Free) | Cloudflare D1 |
|------|-------------|---------------|
| 容量 | 9GB | 5GB |
| Reads | 1B/月 | 5M/日 |
| Writes | 25M/月 | 100K/日 |
| レプリカ | 3箇所 | グローバル |
| **結論** | 大規模向け | **小〜中規模で十分** |

スタートアップフェーズではD1で十分。スケール時にTursoへ移行可能。
:::

### 翻訳・AI（コスト最重要）

| モデル | 入力コスト | 出力コスト | 品質 | 用途 |
|--------|-----------|-----------|------|------|
| **Gemini 2.0 Flash** | $0.10/1M | $0.40/1M | ◎ | **メイン翻訳** |
| Claude 3.5 Haiku | $0.25/1M | $1.25/1M | ◎ | 高品質が必要な場合 |
| DeepL API Free | 無料 | 無料 | ○ | 500K文字/月まで |
| Claude 3.5 Sonnet | $3.00/1M | $15.00/1M | ◎◎ | プレミアム用 |

:::caution[翻訳コスト試算]
**1章（3,000文字）の翻訳コスト:**
| モデル | コスト | 月100章 | 月1000章 |
|--------|-------|---------|----------|
| Gemini Flash | $0.002 | $0.20 | $2.00 |
| Claude Haiku | $0.006 | $0.60 | $6.00 |
| Claude Sonnet | $0.07 | $7.00 | $70.00 |

**結論**: Gemini Flash をメインにすることで **翻訳コストを95%削減**
:::

### インフラ・DevOps

| カテゴリ | 技術 | 月額コスト |
|---------|------|-----------|
| CI/CD | **GitLab CI** (GitLab.comの場合) | $0 |
| モニタリング | Sentry (Developer) | $0 |
| ログ | Cloudflare Logs | $0 |
| 分析 | **Cloudflare Analytics** | $0 |

---

## 詳細コスト見積もり

### Phase 1: MVP（月間1,000ユーザー想定）

| サービス | プラン | 月額 |
|---------|--------|------|
| Cloudflare Pages | Free | $0 |
| Cloudflare Workers | Free (100K/日) | $0 |
| Cloudflare D1 | Free (5GB) | $0 |
| Cloudflare KV | Free | $0 |
| Cloudflare R2 | Free (10GB) | $0 |
| Gemini API | ~50章/日翻訳 | ~$3 |
| DeepL API | Free (バックアップ) | $0 |
| ドメイン | .com | ~$12/年 = $1 |
| Sentry | Developer | $0 |
| **合計** | | **~$4/月** |

### Phase 2: 成長期（月間10,000ユーザー想定）

| サービス | プラン | 月額 |
|---------|--------|------|
| Cloudflare Pages | Free | $0 |
| Cloudflare Workers | Paid ($5 + 従量) | ~$10 |
| Cloudflare D1 | Paid | ~$5 |
| Cloudflare R2 | ~50GB使用 | ~$2 |
| Gemini API | ~500章/日 | ~$30 |
| Claude Haiku | プレミアム用 | ~$20 |
| ドメイン | .com | $1 |
| Sentry | Developer | $0 |
| **合計** | | **~$70/月** |

### Phase 3: スケール期（月間100,000ユーザー想定）

| サービス | プラン | 月額 |
|---------|--------|------|
| Cloudflare Pages | Free | $0 |
| Cloudflare Workers | Paid | ~$50 |
| Cloudflare D1 → Turso | Scaler | ~$30 |
| Cloudflare R2 | ~500GB | ~$10 |
| Gemini API | メイン | ~$100 |
| Claude Sonnet | プレミアム | ~$100 |
| ドメイン | .com | $1 |
| Sentry | Team | $26 |
| **合計** | | **~$320/月** |

---

## Cloudflare 無料枠の詳細

### Workers

| 項目 | Free | Paid ($5/月〜) |
|------|------|---------------|
| リクエスト | 100,000/日 | 10M/月 + $0.30/M |
| CPU時間 | 10ms/リクエスト | 50ms/リクエスト |
| メモリ | 128MB | 128MB |

### D1 (SQLite)

| 項目 | Free | Paid |
|------|------|------|
| ストレージ | 5GB | $0.75/GB |
| Reads | 5M/日 | $0.001/M |
| Writes | 100K/日 | $1.00/M |

### KV

| 項目 | Free | Paid |
|------|------|------|
| Reads | 100,000/日 | $0.50/M |
| Writes | 1,000/日 | $5.00/M |
| ストレージ | 1GB | $0.50/GB |

### R2

| 項目 | Free | Paid |
|------|------|------|
| ストレージ | 10GB/月 | $0.015/GB |
| Class A ops | 1M/月 | $4.50/M |
| Class B ops | 10M/月 | $0.36/M |
| Egress | **無料** | **無料** |

:::tip[R2 の強み]
AWS S3 と違い、**データ転送（Egress）が完全無料**。
画像配信が多いサービスでは大幅なコスト削減になる。
:::

---

## 全文検索のコスト最適化

### 選択肢比較

| サービス | 月額 | 特徴 |
|---------|------|------|
| Meilisearch Cloud | $30〜 | 高機能、日本語対応 |
| Algolia | $35〜 | 高機能、高コスト |
| **D1 FTS5** | **$0** | SQLite組込、十分な性能 |
| **Pagefind** | **$0** | 静的サイト向け、軽量 |

### 推奨: D1 FTS5

```sql
-- FTS5 仮想テーブルの作成
CREATE VIRTUAL TABLE novels_fts USING fts5(
  title,
  synopsis,
  content='novels',
  content_rowid='rowid',
  tokenize='unicode61'
);

-- 日本語対応トリガー（更新時に自動同期）
CREATE TRIGGER novels_ai AFTER INSERT ON novels BEGIN
  INSERT INTO novels_fts(rowid, title, synopsis)
  VALUES (new.rowid, new.title, new.synopsis);
END;

-- 検索クエリ
SELECT * FROM novels_fts WHERE novels_fts MATCH '異世界 転生';
```

**Phase 2以降で検索品質が課題になったら Meilisearch に移行可能**

---

## フロントエンドの最適化

### Astro の採用理由

| 項目 | Next.js | Astro |
|------|---------|-------|
| バンドルサイズ | 大きい | **極小** |
| 初期JS | ~100KB | **0KB可能** |
| ビルド時間 | 長い | **短い** |
| 島アーキテクチャ | なし | **あり** |
| SSR | 必要 | **オプション** |

```
┌─────────────────────────────────────────────────────────────┐
│                  Astro Islands Architecture                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────────┐ │
│  │              静的HTML (SSG/SSR)                       │ │
│  │                                                       │ │
│  │   ┌─────────────┐           ┌─────────────┐         │ │
│  │   │ React Island│           │ React Island│         │ │
│  │   │ (インタラ   │           │ (コメント   │         │ │
│  │   │  クティブ)  │           │  フォーム)  │         │ │
│  │   └─────────────┘           └─────────────┘         │ │
│  │                                                       │ │
│  │   残りは純粋な HTML + CSS (JS不要)                   │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  メリット:                                                  │
│  - 初期ロードが超高速                                       │
│  - JS は必要な部分だけロード                                │
│  - SEO 最適                                                 │
│  - Cloudflare Pages と相性◎                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 推奨構成

```
frontend/
├── src/
│   ├── pages/                  # ファイルベースルーティング
│   │   ├── index.astro         # トップページ（静的）
│   │   ├── novels/
│   │   │   ├── index.astro     # 一覧（静的 + 島）
│   │   │   └── [id].astro      # 詳細（SSR）
│   │   └── dashboard/
│   │       └── [...].astro     # 作家ダッシュボード（SPA島）
│   ├── components/
│   │   ├── static/             # 静的コンポーネント（Astro）
│   │   └── islands/            # インタラクティブ（React/Svelte）
│   │       ├── SearchBox.tsx
│   │       ├── BookmarkButton.tsx
│   │       └── CommentForm.tsx
│   └── layouts/
├── astro.config.mjs
└── package.json
```

---

## 翻訳パイプライン（コスト最適化版）

### 翻訳モデル選択ロジック

```
┌─────────────────────────────────────────────────────────────┐
│                Translation Model Selection                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  章が投稿される                                              │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────┐                                       │
│  │ ユーザー種別?   │                                       │
│  └────────┬────────┘                                       │
│           │                                                 │
│     ┌─────┴─────┐                                          │
│     ▼           ▼                                          │
│  ┌──────┐   ┌──────┐                                       │
│  │無料  │   │有料  │                                       │
│  │ユーザー│ │ユーザー│                                      │
│  └──┬───┘   └──┬───┘                                       │
│     │          │                                            │
│     ▼          ▼                                            │
│  ┌──────────┐ ┌──────────┐                                 │
│  │DeepL Free│ │品質設定? │                                 │
│  │(月500K字)│ └────┬─────┘                                 │
│  └────┬─────┘      │                                       │
│       │      ┌─────┴─────┐                                 │
│       │      ▼           ▼                                 │
│       │  ┌──────┐   ┌──────┐                              │
│       │  │標準  │   │高品質│                              │
│       │  └──┬───┘   └──┬───┘                              │
│       │     │          │                                   │
│       ▼     ▼          ▼                                   │
│  ┌─────────────┐  ┌─────────────┐                         │
│  │Gemini Flash │  │Claude Haiku │                         │
│  │$0.002/章    │  │$0.006/章    │                         │
│  └─────────────┘  └─────────────┘                         │
│                                                             │
│  ※プレミアム作品は Claude Sonnet ($0.07/章)               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### バッチ翻訳でさらにコスト削減

```typescript
// 複数章をまとめて翻訳（API呼び出し回数削減）
async function batchTranslate(chapters: Chapter[], targetLang: string) {
  // 5章ずつまとめて翻訳
  const batches = chunk(chapters, 5);

  for (const batch of batches) {
    const combinedText = batch
      .map((ch, i) => `[CHAPTER_${i}]\n${ch.content}\n[/CHAPTER_${i}]`)
      .join('\n\n');

    const result = await translateWithGemini(combinedText, targetLang);

    // 結果を分割して保存
    const translations = parseChapters(result);
    await saveTranslations(translations);
  }
}
```

---

## 認証（変更なし）

Lucia Auth + Cloudflare D1 で $0 を維持。

### OAuth プロバイダー（すべて無料）

- Google OAuth
- GitHub OAuth
- Discord OAuth

---

## キャッシュ戦略（強化版）

### 積極的なキャッシュでコスト削減

```
┌─────────────────────────────────────────────────────────────┐
│                    Caching Strategy                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【レイヤー1: Cloudflare CDN】                               │
│  - 静的アセット: 1年                                        │
│  - 小説カバー画像: 1週間                                    │
│  - 翻訳済み章: 1日                                          │
│                                                             │
│  【レイヤー2: Cloudflare KV】                                │
│  - ランキング: 10分                                         │
│  - 人気小説メタデータ: 5分                                  │
│  - ユーザーセッション: 24時間                               │
│                                                             │
│  【レイヤー3: D1 クエリキャッシュ】                          │
│  - 小説詳細: 1分                                            │
│  - 章一覧: 1分                                              │
│                                                             │
│  【レイヤー4: ブラウザキャッシュ】                           │
│  - Service Worker によるオフライン対応                      │
│  - 読んだ章をローカルにキャッシュ                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### キャッシュヒット率目標

| リソース | 目標ヒット率 | 効果 |
|---------|-------------|------|
| 静的アセット | 99% | CDN負荷最小化 |
| 翻訳済み章 | 95% | D1クエリ削減 |
| ランキング | 99% | 計算コスト削減 |

---

## スケールアップ戦略

### Phase 1 → Phase 2 への移行トリガー

| 指標 | 閾値 | アクション |
|------|------|-----------|
| Workers リクエスト | 80K/日超 | Paid プラン |
| D1 ストレージ | 4GB超 | Paid プラン |
| 翻訳量 | 100章/日超 | バッチ最適化 |

### Phase 2 → Phase 3 への移行トリガー

| 指標 | 閾値 | アクション |
|------|------|-----------|
| D1 書き込み | 80K/日超 | Turso 移行 |
| 検索品質 | ユーザー不満 | Meilisearch 導入 |
| 翻訳品質 | プレミアム需要 | Claude Sonnet 追加 |

---

## モニタリング（無料）

### 無料で使えるツール

| 用途 | ツール | コスト |
|------|--------|--------|
| エラー追跡 | Sentry (Developer) | $0 |
| アクセス解析 | Cloudflare Analytics | $0 |
| パフォーマンス | Cloudflare Web Analytics | $0 |
| アップタイム | UptimeRobot (Free) | $0 |
| ログ | Cloudflare Logs | $0 |

---

## まとめ: コスト最適化のポイント

### 1. Cloudflareに統一

```
Before:
  Vercel ($20) + Cloudflare + Turso + Meilisearch ($30) = $50+

After:
  Cloudflare (Pages + Workers + D1 + KV + R2) = $0
```

### 2. 翻訳モデルの最適化

```
Before:
  Claude Sonnet ($0.07/章) × 100章/日 = $210/月

After:
  Gemini Flash ($0.002/章) × 100章/日 = $6/月
  + DeepL Free (500K文字/月) = $0
```

### 3. 全文検索の内製化

```
Before:
  Meilisearch Cloud = $30/月

After:
  D1 FTS5 = $0
```

### 4. 段階的スケール

```
MVP: すべて無料枠内 = ~$5/月
成長期: 必要な部分だけ有料 = ~$70/月
スケール期: 本格投資 = ~$300/月
```

---

## 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [API設計書](/specs/api-design/) | RESTful API 仕様 |
| [DB設計書](/specs/db-design/) | データベース設計 |
| [翻訳機能仕様](/specs/features-translation/) | 翻訳機能詳細 |
| [用語集](/specs/glossary/) | 用語定義 |
