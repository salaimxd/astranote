---
title: "pnpm 移行ノート"
type: technical
status: active
role: Engineer
tags: [pnpm, migration, monorepo, workspace]
---

# pnpm 移行ノート

## 概要

このプロジェクトは npm から pnpm に移行しました。

**移行日**: 2026-01-27
**pnpm バージョン**: 10.28.0

## 移行の理由

- **ディスク容量の節約**: シンボリックリンクによる共有ストレージ
- **インストール速度の向上**: 並列ダウンロードと効率的なキャッシング
- **より厳密な依存関係管理**: phantom dependencies の防止
- **monorepo サポート**: ワークスペース機能の充実

## ワークスペース構成

```yaml
# pnpm-workspace.yaml
packages:
  - 'app'      # Astro + Svelte フロントエンド
  - 'backend'  # Cloudflare Workers バックエンド
```

## よく使うコマンド

```bash
# すべてのパッケージをインストール
pnpm install

# 特定のワークスペースでコマンド実行
pnpm -F app run dev
pnpm -F backend run dev

# すべてのワークスペースでビルド
pnpm -r run build

# 特定のワークスペースにパッケージ追加
pnpm -F app add <package-name>
pnpm -F backend add -D <package-name>

# ルートに共通パッケージ追加
pnpm add -w <package-name>
```

## インストール時の警告について

### 1. Peer Dependency 警告

```
@sveltejs/vite-plugin-svelte 5.1.1
├── ✕ unmet peer vite@^6.0.0: found 7.3.1
```

**現状**: Astro 5 が Vite 7 を使用しているため発生
**影響**: なし（ビルドは正常に動作）
**対応**: Svelte プラグインの次期バージョンで Vite 7 対応予定のため、現状維持

### 2. Deprecated パッケージ警告

```
oslo@1.2.1 deprecated
lucia@3.2.2 deprecated
@lucia-auth/adapter-sqlite@3.0.2 deprecated
```

**現状**: Lucia 認証ライブラリが非推奨
**影響**: 現在の動作に問題なし
**対応計画**:
- 後継プロジェクト OsloJS (https://oslojs.dev) への移行を検討
- または他の認証ライブラリ（Auth.js、Clerk など）への移行

### 3. Build Scripts 警告

```
Ignored build scripts: better-sqlite3@11.10.0, esbuild@*, sharp@0.34.5, workerd@*
```

**現状**: pnpm v10.26+ のセキュリティ機能によりビルドスクリプトが制限される
**対応**: postinstall フックで自動的に `better-sqlite3` を再ビルド
**影響**: なし（ネイティブモジュールは正常に動作）

## トラブルシューティング

### better-sqlite3 が動作しない場合

```bash
# 手動で再ビルド
pnpm rebuild better-sqlite3

# または
cd node_modules/.pnpm/better-sqlite3@*/node_modules/better-sqlite3
npx prebuild-install
```

### すべてのパッケージを再インストール

```bash
rm -rf node_modules app/node_modules backend/node_modules
pnpm install
```

## 設定ファイル

### .npmrc

```ini
# pnpm configuration

# Disable package script approval (pnpm v10.26+)
# This allows build scripts to run automatically for all packages
# Security note: Only use in trusted development environments
package-script-approval=false
```

### package.json (root)

```json
{
  "scripts": {
    "postinstall": "pnpm rebuild better-sqlite3 2>/dev/null || true"
  }
}
```

## CI/CD での注意点

CI/CD パイプラインを設定する際は、以下を確認してください：

1. pnpm のインストール
   ```bash
   npm install -g pnpm
   ```

2. 依存関係のインストール
   ```bash
   pnpm install --frozen-lockfile
   ```

3. ビルドコマンド
   ```bash
   pnpm -r run build
   ```

## 参考リンク

- [pnpm 公式ドキュメント](https://pnpm.io/)
- [pnpm ワークスペース](https://pnpm.io/workspaces)
- [OsloJS (Lucia 後継)](https://oslojs.dev)
