---
title: "技術仕様書: ルビ(振り仮名)システム"
type: technical
status: active
role: Engineer
tags: [techspec, tiptap, ruby, editor, japanese]
---

# 技術仕様書: ルビ(振り仮名)システム

> **利用職種**: Engineer (主), TechLead


## 概要

本仕様書は、Astranote の Tiptap エディタに日本語のルビ(振り仮名)機能を実装するための技術仕様を定義します。

ルビ機能により、漢字や難読語に読み仮名を付与でき、読者にとって親しみやすいコンテンツを作成できます。
本機能は、小説・ライトノベル・教育コンテンツなど、日本語コンテンツの作成に特化した重要な機能です。

### 設計方針

- **Tiptap ネイティブ**: Tiptap のカスタムノード・マークとして実装し、エコシステムと完全に統合
- **標準HTML準拠**: `<ruby>`, `<rb>`, `<rt>` タグを使用し、エクスポート時にも標準的なHTMLを出力
- **青空文庫互換**: `｜漢字《よみがな》` 形式のパーサーを実装し、既存の青空文庫形式テキストの取り込みに対応
- **UX重視**: キーボードショートカット(Alt+R)とダイアログUIの両方で、直感的な操作を実現


## システムアーキテクチャ

### アーキテクチャ構成図

```
┌─ TiptapEditor (Svelte Component) ───────────────────┐
│  ├─ Editor Instance                                  │
│  │   ├─ StarterKit                                  │
│  │   ├─ Placeholder                                 │
│  │   └─ Ruby Extension (新規)                       │
│  │                                                   │
│  ├─ Keyboard Shortcuts                              │
│  │   └─ Alt+R → Open RubyDialog                   │
│  │                                                   │
│  └─ RubyDialog.svelte (新規)                        │
│      └─ Input: 漢字, 読み仮名                        │
└──────────────────────────────────────────────────────┘
                        ↕
┌─ Data Flow ──────────────────────────────────────────┐
│  Content (HTML)                                      │
│  ↓                                                   │
│  Ruby Parser (青空文庫形式 → HTML変換)                │
│  ↓                                                   │
│  Tiptap Editor (編集)                                │
│  ↓                                                   │
│  Export (HTML保持、またはプレーンテキスト変換)        │
└──────────────────────────────────────────────────────┘
```

### 技術スタック

| コンポーネント | 技術 | バージョン | 採用理由 |
|---------------|------|-----------|----------|
| エディタコア | Tiptap | 3.16.0 | リッチテキストエディタの基盤 |
| フロントエンド | Svelte | 5.48.0 | Astroプロジェクトで採用済み |
| UI | Tailwind CSS | 4.1.18 | 既存のスタイリングシステム |
| データ構造 | ProseMirror Schema | (Tiptap内包) | Tiptapの内部データ構造 |
| パーサー | 正規表現 + カスタムロジック | - | 青空文庫形式の解析 |

### 設計原則

#### 1. 拡張性
- Tiptapの拡張システムを活用し、既存コードへの影響を最小化
- 将来的な機能追加(縦中横、傍点など)に対応できる構造

#### 2. 保守性
- コードを責務ごとに分離: Extension / Parser / UI
- TypeScript による型安全性の確保

#### 3. パフォーマンス
- ルビの挿入・編集はローカル処理のみで完結
- DOMの最小限の更新で描画コストを削減


## フロントエンド設計

### ディレクトリ構成

```
app/src/
├── lib/
│   ├── extensions/
│   │   └── ruby.ts              # Tiptap Ruby Extension (新規)
│   └── parsers/
│       └── ruby.parser.ts       # 青空文庫形式パーサー (新規)
├── components/
│   └── interactive/
│       ├── TiptapEditor.svelte  # 既存ファイル (編集)
│       └── RubyDialog.svelte    # ルビ挿入ダイアログ (新規)
└── utils/
    └── export.ts                # 既存ファイル (確認のみ)
```

### コンポーネント設計

#### Ruby Extension (`app/src/lib/extensions/ruby.ts`)

**責務**:
- Tiptap のカスタムマークとしてルビ機能を実装
- ProseMirror スキーマでルビ構造を定義
- HTML への変換・パースロジックを提供

**主要メソッド**:
- `addAttributes()`: `base` (本文), `text` (ルビテキスト) を定義
- `parseHTML()`: `<ruby>` タグから属性を抽出
- `renderHTML()`: 属性から `<ruby><rb>本文</rb><rt>ルビ</rt></ruby>` を生成
- `addCommands()`: `setRuby()`, `unsetRuby()` コマンドを追加

**データ構造**:
```typescript
interface RubyAttributes {
  base: string;    // 本文(漢字など)
  text: string;    // ルビ(読み仮名)
}
```

#### Ruby Parser (`app/src/lib/parsers/ruby.parser.ts`)

**責務**:
- 青空文庫形式 `｜漢字《よみがな》` を検出
- HTML `<ruby>` タグに変換
- 逆変換(HTMLから青空文庫形式へ)も提供

**パースルール**:
- `｜` で始まり、`《` と `》` で囲まれた部分がルビ
- `｜` が省略された場合は、漢字のみにルビが付与されたと解釈(オプション)

**サンプルコード**:
```typescript
export function parseAozoraRuby(text: string): string {
  // ｜漢字《よみがな》 → <ruby><rb>漢字</rb><rt>よみがな</rt></ruby>
  return text.replace(/｜([^《]+)《([^》]+)》/g,
    '<ruby><rb>$1</rb><rt>$2</rt></ruby>');
}

export function toAozoraRuby(html: string): string {
  // <ruby><rb>漢字</rb><rt>よみがな</rt></ruby> → ｜漢字《よみがな》
  return html.replace(/<ruby><rb>([^<]+)<\/rb><rt>([^<]+)<\/rt><\/ruby>/g,
    '｜$1《$2》');
}
```

#### RubyDialog.svelte (`app/src/components/interactive/RubyDialog.svelte`)

**責務**:
- ルビの挿入・編集UIを提供
- ユーザー入力を受け取り、エディタにコマンドを送信

**Props**:
- `isOpen: boolean` - ダイアログの表示状態
- `initialBase?: string` - 初期値(選択テキスト)
- `initialText?: string` - 初期値(既存のルビ)
- `onSubmit: (base: string, text: string) => void` - 送信時コールバック
- `onClose: () => void` - キャンセル時コールバック

**State**:
- `base: string` - 本文入力値
- `text: string` - ルビ入力値

**UI構成**:
```
┌─ Dialog ────────────────────────┐
│  ルビを追加                      │
│  ┌─────────────────────────┐   │
│  │ 本文: [        ]        │   │
│  │ 読み: [        ]        │   │
│  └─────────────────────────┘   │
│  [キャンセル]  [挿入]            │
└─────────────────────────────────┘
```

#### TiptapEditor.svelte (既存ファイルの修正)

**変更点**:
1. Ruby Extension をインポートし、`extensions` 配列に追加
2. `Alt+R` ショートカットで `RubyDialog` を開くロジックを追加
3. `RubyDialog` コンポーネントを配置し、`onSubmit` で `editor.commands.setRuby()` を呼び出す


## データモデル

### ProseMirror スキーマ

Tiptap の Ruby Extension は、ProseMirror の **Mark** として実装されます。

```typescript
const RubyMark = Mark.create({
  name: 'ruby',

  addAttributes() {
    return {
      base: {
        default: null,
        parseHTML: element => element.querySelector('rb')?.textContent,
        renderHTML: attributes => {
          return { 'data-base': attributes.base };
        },
      },
      text: {
        default: null,
        parseHTML: element => element.querySelector('rt')?.textContent,
        renderHTML: attributes => {
          return { 'data-text': attributes.text };
        },
      },
    };
  },

  parseHTML() {
    return [
      {
        tag: 'ruby',
      },
    ];
  },

  renderHTML({ HTMLAttributes }) {
    const { base, text } = HTMLAttributes;
    return [
      'ruby',
      {},
      ['rb', {}, base],
      ['rt', {}, text],
    ];
  },
});
```

### HTML出力形式

**標準HTML (エクスポート時)**:
```html
<ruby>
  <rb>漢字</rb>
  <rt>かんじ</rt>
</ruby>
```

**青空文庫形式 (オプション)**:
```
｜漢字《かんじ》
```


## API設計

### Tiptap コマンド

#### setRuby
- **説明**: 選択範囲にルビを設定
- **引数**: `{ base: string, text: string }`
- **戻り値**: `boolean` (成功/失敗)

```typescript
editor.commands.setRuby({ base: '漢字', text: 'かんじ' })
```

#### unsetRuby
- **説明**: 選択範囲のルビを解除
- **引数**: なし
- **戻り値**: `boolean` (成功/失敗)

```typescript
editor.commands.unsetRuby()
```

#### toggleRuby
- **説明**: ルビの設定/解除を切り替え
- **引数**: `{ base: string, text: string }`
- **戻り値**: `boolean` (成功/失敗)

```typescript
editor.commands.toggleRuby({ base: '漢字', text: 'かんじ' })
```


## シーケンス図

### ルビ挿入フロー

```
User -> TiptapEditor: テキストを選択
User -> TiptapEditor: Alt+R を押下
TiptapEditor -> RubyDialog: ダイアログを開く (選択テキストを渡す)
User -> RubyDialog: 読み仮名を入力
User -> RubyDialog: [挿入] ボタンをクリック
RubyDialog -> TiptapEditor: onSubmit(base, text)
TiptapEditor -> Editor: editor.commands.setRuby({ base, text })
Editor -> ProseMirror: Mark を挿入
ProseMirror -> DOM: <ruby> 要素を描画
DOM -> User: ルビが表示される
```

### 青空文庫形式のパース

```
User -> TiptapEditor: 青空文庫形式テキストを貼り付け
TiptapEditor -> RubyParser: parseAozoraRuby(text)
RubyParser -> RubyParser: 正規表現でマッチング
RubyParser -> TiptapEditor: HTML形式に変換
TiptapEditor -> Editor: editor.commands.setContent(html)
Editor -> DOM: <ruby> 要素を描画
```


## エラーハンドリング

### エラーケース

| エラーケース | 処理 |
|-------------|------|
| 本文が空 | ダイアログでバリデーションエラーを表示 |
| 読み仮名が空 | ダイアログでバリデーションエラーを表示 |
| 選択範囲なし | 現在のカーソル位置に挿入(または警告表示) |
| 不正な青空文庫形式 | パースをスキップし、元のテキストを保持 |


## テスト戦略

### テストケース

#### Ruby Extension のテスト
- [ ] 正常系: `setRuby()` でルビが挿入される
- [ ] 正常系: `unsetRuby()` でルビが解除される
- [ ] 正常系: HTML → ProseMirror のパースが正しい
- [ ] 正常系: ProseMirror → HTML の変換が正しい
- [ ] 異常系: 空の base/text で挿入できない

#### Ruby Parser のテスト
- [ ] 正常系: `｜漢字《かんじ》` → `<ruby>` 変換
- [ ] 正常系: `<ruby>` → `｜漢字《かんじ》` 逆変換
- [ ] エッジケース: 複数のルビが含まれるテキスト
- [ ] エッジケース: `｜` が本文中に含まれる場合

#### RubyDialog のテスト
- [ ] 正常系: 入力値が onSubmit に渡される
- [ ] 異常系: 空の入力でバリデーションエラー
- [ ] UI: Esc キーでダイアログが閉じる


## 実装タスク

### 優先度: 🔴 高
### 工数: 5日

| タスク | 担当 | 工数 | 状態 |
|--------|------|------|------|
| Ruby Extension 実装 | - | 1日 | ⬜ 未着手 |
| Ruby Parser 実装 | - | 0.5日 | ⬜ 未着手 |
| RubyDialog UI 実装 | - | 1日 | ⬜ 未着手 |
| TiptapEditor 統合 | - | 0.5日 | ⬜ 未着手 |
| ショートカットキー設定 | - | 0.5日 | ⬜ 未着手 |
| エクスポート機能確認 | - | 0.5日 | ⬜ 未着手 |
| テスト実装 | - | 1日 | ⬜ 未着手 |


## 非機能要件

### パフォーマンス
- ルビ挿入操作は 100ms 以内に完了
- 大量のルビ(100個以上)を含む文書でもスムーズに編集可能

### アクセシビリティ
- `<ruby>` タグは標準HTMLのため、スクリーンリーダーで読み上げ可能
- ダイアログはキーボード操作のみで完結可能


## 依存関係とリスク

### 外部依存

| 依存サービス | 用途 | リスク | 対策 |
|-------------|------|--------|------|
| Tiptap | エディタコア | バージョンアップで破壊的変更 | メジャーバージョン固定 |
| ProseMirror | データ構造 | Schema変更 | Tiptap経由で抽象化 |

### 技術的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| 青空文庫形式のエッジケース | Medium | Low | 正規表現を厳密にテスト |
| ブラウザ互換性(古いブラウザ) | Low | Low | モダンブラウザのみサポート |
| ルビ要素のカーソル位置問題 | Medium | Medium | `code: true`, `spanning: false`, `excludes: '_'` + CSS調整で対応 |


## オープンクエスチョン

- [x] **Q1**: ルビの編集方法は? → A: 既存のルビをクリック後、再度 Alt+R で編集ダイアログを開く
- [x] **Q2**: エクスポート形式は? → A: HTML形式を標準とし、青空文庫形式はオプション機能として将来実装
- [x] **Q3**: カーソル位置の問題は? → A: `code: true`, `spanning: false`, `excludes: '_'` プロパティとCSS調整で対応
- [ ] **Q4**: 縦書き表示への対応は? → 決定者: TBD, 期限: TBD (Phase 3 で検討)


## 関連ドキュメント

- [53.01_Implementation_Tasks_Multilingual.md](53.01_Implementation_Tasks_Multilingual.md) - Phase 2 タスクリスト
- [52.01_ADR_Tech_Stack.md](52.01_ADR_Tech_Stack.md) - 技術選定の背景
