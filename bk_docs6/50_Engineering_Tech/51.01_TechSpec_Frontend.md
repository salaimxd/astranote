---
title: "技術仕様書：フロントエンド"
type: technical
status: active
role: Engineer
tags: [techspec, frontend, astro, svelte, tiptap, islands]
---

# 技術仕様書：フロントエンド

> **テンプレート利用ガイド**
> フロントエンドの詳細設計書です。
> **利用職種**: Frontend Engineer
> **最終更新**: 2026-01-28

---

## 1. 概要 (Overview)

AstraNote は、Astro 5のアイランドアーキテクチャを採用し、パフォーマンスとユーザー体験を最大化する。

**戦略**:
- 静的HTMLで最速の初期ロード
- 必要な部分だけをインタラクティブに（Svelte）
- サーバーサイドレンダリング（SSR）による認証とデータ取得

---

## 2. 技術スタック

### コア技術
- **Framework**: Astro 5（SSG/SSR）
- **Interactive UI**: Svelte 5（インタラクティブコンポーネント）
- **Language**: TypeScript
- **Styling**: Tailwind CSS
- **Rich Text Editor**: Tiptap（ProseMirror）
- **State Management**: Nanostores（軽量、フレームワーク非依存）
- **Hosting**: Cloudflare Pages

### 開発ツール
- **Package Manager**: npm
- **Build Tool**: Vite（Astro組み込み）
- **Linter**: ESLint
- **Formatter**: Prettier

---

## 3. アイランドアーキテクチャ

### 概念

Astroのアイランドアーキテクチャは、ページ全体をデフォルトで静的HTMLとして配信し、インタラクティブ性が必要な部分（"アイランド"）だけをJavaScriptでハイドレーションする。

### ハイドレーション戦略

| ディレクティブ | タイミング | 用途 |
|--------------|-----------|------|
| `client:load` | ページロード時 | エディタなど最優先のインタラクティブ要素 |
| `client:idle` | ブラウザアイドル時 | ヘッダー、ナビゲーション（重要だが即座でなくてもOK） |
| `client:visible` | 画面表示時 | スクロールで見える要素（グラフ、統計ダッシュボード） |
| なし（静的HTML） | - | インタラクションがない要素（カード、テキスト） |

### 実装例

```astro
---
import Header from '@/components/layout/Header.svelte';
import NovelCard from '@/components/home/NovelCard.svelte';
import StatsDashboard from '@/components/interactive/StatsDashboard.svelte';
import TiptapEditor from '@/components/interactive/TiptapEditor.svelte';
---

<Layout>
  <!-- ブラウザがアイドル状態になったらロード -->
  <Header client:idle />

  <!-- 静的HTML（JavaScriptなし） -->
  <NovelCard novel={novel} />

  <!-- 画面に表示されたらロード -->
  <StatsDashboard client:visible />

  <!-- 即座にロード（エディタの中核機能） -->
  <TiptapEditor client:load />
</Layout>
```

### パフォーマンス効果

```
【トップページ】
最適化前: 165KB JavaScript（即座にロード）
最適化後: 0KB JavaScript（初期）+ 15KB（アイドル時）
削減率: 91%
```

**詳細**: [52.05_ADR_Islands_Architecture_Performance.md](52.05_ADR_Islands_Architecture_Performance.md)

---

## 4. ディレクトリ構造

```text
app/
├── src/
│   ├── components/          # UIコンポーネント
│   │   ├── layout/          # レイアウトコンポーネント (.svelte)
│   │   │   ├── Header.svelte
│   │   │   ├── Footer.svelte
│   │   │   └── EditorSidebar.svelte
│   │   ├── home/            # トップページコンポーネント (.svelte)
│   │   │   └── NovelCard.svelte
│   │   └── interactive/     # インタラクティブコンポーネント (.svelte)
│   │       ├── TiptapEditor.svelte
│   │       ├── ChapterList.svelte
│   │       ├── StatsDashboard.svelte
│   │       └── EditorToolbar.svelte
│   ├── layouts/             # ページレイアウト (.astro)
│   │   ├── EditorLayout.astro
│   │   └── PublicLayout.astro
│   ├── pages/               # ファイルベースルーティング (.astro)
│   │   ├── index.astro                  # トップページ（公開小説一覧）
│   │   ├── my-novels.astro             # マイ小説（SSR）
│   │   ├── editor/
│   │   │   ├── index.astro
│   │   │   └── [novelId].astro         # エディタ（SSR）
│   │   ├── novels/
│   │   │   ├── new.astro               # 新規作成（SSR）
│   │   │   └── [id].astro              # 小説詳細（SSR）
│   │   └── stats/
│   │       └── index.astro             # 執筆統計（SSR）
│   ├── lib/                 # ライブラリコード
│   │   ├── api/             # API クライアント
│   │   │   ├── client.ts              # 基盤（クライアント・サーバー両対応）
│   │   │   ├── auth.ts                # 認証API
│   │   │   ├── novels.ts              # 小説API
│   │   │   └── chapters.ts            # チャプターAPI
│   │   ├── extensions/      # Tiptap拡張
│   │   │   ├── ruby.ts                # ルビ
│   │   │   └── emphasis-dot.ts        # 傍点
│   │   └── utils/           # ユーティリティ
│   ├── stores/              # Nanostores状態管理
│   │   ├── auth.ts                    # 認証状態
│   │   ├── chapters.ts                # チャプター状態
│   │   └── ui.ts                      # UI状態（サイドバー、フォーカスモード）
│   ├── middleware/          # Astroミドルウェア
│   │   └── index.ts                   # 認証チェック
│   └── env.d.ts             # 型定義
├── public/                  # 静的ファイル
├── astro.config.mjs         # Astro設定
├── tailwind.config.mjs      # Tailwind設定
├── tsconfig.json            # TypeScript設定
└── package.json             # 依存関係
```

---

## 5. 主要コンポーネント

### 5.1. レイアウトコンポーネント

#### Header（`components/layout/Header.svelte`）
**ディレクティブ**: `client:idle`

**機能**:
- 認証状態表示
- ログイン/ログアウト
- テーマ切り替え（ダーク/ライト）
- ナビゲーションメニュー

**状態**:
- `currentUser`: Nanostores（`stores/auth.ts`）
- `currentTheme`: ローカルストレージ

#### NovelCard（`components/home/NovelCard.svelte`）
**ディレクティブ**: なし（静的HTML）

**機能**:
- 小説カード表示（タイトル、説明、著者、タグ）
- 小説詳細ページへのリンク

**注意**: JavaScriptなし、完全に静的HTML

### 5.2. インタラクティブコンポーネント

#### TiptapEditor（`components/interactive/TiptapEditor.svelte`）
**ディレクティブ**: `client:load`

**機能**:
- リッチテキスト編集（Tiptap）
- ルビ・傍点の挿入
- 自動保存（3秒後）
- 文字数・単語数カウント

**状態**:
- `currentChapterId`: Nanostores（`stores/chapters.ts`）
- `editor`: ローカル（Tiptap Editorインスタンス）

**パフォーマンス最適化**:
- `tick()`を使用したDOM待機（setTimeoutを排除）
- リトライロジックでエラーハンドリング

**コード例**:
```typescript
async function initEditor(chapterId: string) {
  // editorElementが準備されるまで最大10回待機
  let retries = 0;
  while (!editorElement && retries < 10) {
    await tick();  // Svelteのtick()でDOM更新を待機
    retries++;
  }

  if (!editorElement) {
    console.error('Failed to initialize editor: element not found');
    return;
  }

  editor = new Editor({
    element: editorElement,
    extensions: [StarterKit, Placeholder, Ruby, EmphasisDot],
    onUpdate: ({ editor }) => {
      // 自動保存ロジック
    },
  });
}
```

#### ChapterList（`components/interactive/ChapterList.svelte`）
**ディレクティブ**: `client:load`

**機能**:
- チャプター一覧表示
- チャプター作成・削除
- チャプター選択（エディタへ反映）

**状態**:
- `chapters`: Nanostores（`stores/chapters.ts`）

#### StatsDashboard（`components/interactive/StatsDashboard.svelte`）
**ディレクティブ**: `client:visible`

**機能**:
- 執筆統計表示
- グラフ・チャート

**最適化**: スクロールして画面に表示されるまでロードしない

---

## 6. API統合

### 6.1. APIクライアント構造

```
app/src/lib/api/
├── client.ts       # 基盤（クライアント・サーバー両対応）
├── auth.ts         # 認証API
├── novels.ts       # 小説API
└── chapters.ts     # チャプターAPI
```

### 6.2. クライアントサイドとサーバーサイドの分離

#### クライアントサイド（Svelteコンポーネント）

```typescript
// app/src/components/interactive/ChapterList.svelte
import { chaptersAPI } from '@/lib/api';

async function loadChapters() {
  // ブラウザから直接APIを呼び出し（credentials: 'include'で自動的にクッキー送信）
  const response = await chaptersAPI.getChapters(novelId);
  chapters.set(response.chapters);
}
```

#### サーバーサイド（Astro .astroファイル）

```astro
---
// app/src/pages/my-novels.astro
import { novelsAPI } from '@/lib/api';

// サーバーサイド用ヘルパー関数（Astro.cookiesを明示的に転送）
const response = await novelsAPI.getMyNovelsFromServer(Astro.cookies, { page, limit });
---
```

### 6.3. サーバーサイドAPI呼び出しの仕組み

**問題**: Astro SSRでは、ブラウザのクッキーが自動で送信されない

**解決**: `requestFromServer`ヘルパー関数で明示的にクッキーを転送

```typescript
// app/src/lib/api/client.ts
export async function requestFromServer<T>(
  endpoint: string,
  cookies: any,
  options: RequestInit = {}
): Promise<T> {
  // セッションクッキーを取得
  const sessionCookie = cookies.get('auth_session');
  const cookieHeader = sessionCookie ? `auth_session=${sessionCookie.value}` : '';

  const response = await fetch(url, {
    headers: {
      'Content-Type': 'application/json',
      'Cookie': cookieHeader,  // 明示的にクッキーを転送
      ...options.headers,
    },
  });

  // ...
}
```

**詳細**: [53.02_Implementation_Tasks_API_Integration.md](53.02_Implementation_Tasks_API_Integration.md)

---

## 7. 状態管理（Nanostores）

### 7.1. 認証状態（`stores/auth.ts`）

```typescript
import { atom } from 'nanostores';

export const currentUser = atom<User | null>(null);
export const isLoggedIn = atom<boolean>(false);
export const authLoading = atom<boolean>(true);

export async function loadCurrentUser() {
  try {
    const user = await authAPI.me();
    currentUser.set(user);
    isLoggedIn.set(true);
  } catch {
    currentUser.set(null);
    isLoggedIn.set(false);
  } finally {
    authLoading.set(false);
  }
}
```

### 7.2. チャプター状態（`stores/chapters.ts`）

```typescript
import { atom } from 'nanostores';

export const chapters = atom<Chapter[]>([]);
export const currentChapterId = atom<string | null>(null);

export async function loadChapters(novelId: string) {
  const response = await chaptersAPI.getChapters(novelId);
  chapters.set(response.chapters);
}
```

### 7.3. UI状態（`stores/ui.ts`）

```typescript
import { atom } from 'nanostores';

export const showSidebar = atom<boolean>(true);
export const focusMode = atom<boolean>(false);

export function toggleSidebar() {
  showSidebar.set(!showSidebar.get());
}
```

---

## 8. レスポンシブデザイン

### ブレークポイント
- **デスクトップ**: 768px以上（`md:` プレフィックス）
- **モバイル/タブレット**: 768px未満

### レイアウト戦略

#### デスクトップ（768px以上）
- サイドバー: `relative` 位置で常時表示
- 幅: 220px（固定）

#### モバイル/タブレット（768px未満）
- サイドバー: `fixed` 位置でオーバーレイ表示
- 幅: 280px（固定）
- 初期状態: 非表示（`-translate-x-full`）
- オーバーレイ: 半透明背景（`bg-black bg-opacity-50`）

---

## 9. SSR/SSGの使い分け

### SSR（Server-Side Rendering）

**用途**: 認証必須ページ、ユーザー固有データ

**設定**:
```astro
---
// ページごとにSSRを有効化
export const prerender = false;
---
```

**該当ページ**:
- `/my-novels` - マイ小説一覧
- `/editor/[novelId]` - エディタ
- `/novels/new` - 新規作成
- `/stats` - 執筆統計
- `/novels/[id]` - 小説詳細（閲覧数更新のため）

### SSG（Static Site Generation）

**用途**: 認証不要、静的コンテンツ

**設定**: デフォルト（`astro.config.mjs`で`output: 'static'`）

**該当ページ**:
- `/` - トップページ（将来的にSSGに変更予定）

---

## 10. パフォーマンス要件

| 指標 | 目標値 | 現状 |
|------|--------|------|
| **初期ロード JS** | < 50KB | 15KB（アイドル時） ✅ |
| **FCP** | < 1.0s | 0.5-0.8s（推定） ✅ |
| **LCP** | < 2.5s | 1.0-1.5s（推定） ✅ |
| **CLS** | 0 | 0 ✅ |
| **SEO** | 完全SSR/SSG | ✅ |

---

## 11. セキュリティ

### XSS対策
- Tiptapの出力はサニタイズ済み
- Astroテンプレートは自動エスケープ

### CSRF対策
- SameSite=Lax クッキー
- Cloudflare Workers の CORS設定

### 認証
- HttpOnly クッキー
- セッション管理（Lucia Auth）

---

## 12. 今後の改善

### Phase 5: トップページ最適化
- [ ] 公開小説一覧のページネーション改善
- [ ] NovelCardのSEO最適化（Open Graph、メタタグ）

### Phase 6: E2Eテスト
- [ ] Playwrightによるテスト追加
- [ ] エディタの自動テスト

### 将来的な機能
- [ ] オフライン対応（Service Worker）
- [ ] Progressive Web App（PWA）化
- [ ] コメント機能のリアルタイム更新

---

## 関連ドキュメント

- [51.01_TechSpec_Backend.md](51.01_TechSpec_Backend.md) - バックエンド技術仕様
- [51.01_TechSpec_Architecture.md](51.01_TechSpec_Architecture.md) - システムアーキテクチャ
- [52.01_ADR_Tech_Stack.md](52.01_ADR_Tech_Stack.md) - MVP技術スタック選定（React + Tauri）
- [52.05_ADR_Islands_Architecture_Performance.md](52.05_ADR_Islands_Architecture_Performance.md) - アイランドアーキテクチャADR
- [53.02_Implementation_Tasks_API_Integration.md](53.02_Implementation_Tasks_API_Integration.md) - API統合実装タスク
- [../40_Design_UX/41.01_UI_Spec_Editor.md](../40_Design_UX/41.01_UI_Spec_Editor.md) - エディタUI仕様

---

## 変更履歴

| 日付       | 変更者 | 変更内容                                                              |
| ---------- | ------ | --------------------------------------------------------------------- |
| 2026/01/28 | Salaim | bkから統合、YAMLフロントマター統一、関連ドキュメントリンク修正（481行） |
| 2026-01-26 | Claude | Svelte + API統合 + アイランドアーキテクチャの完全な実装を反映          |
| 2026-01-25 | Claude | レスポンシブデザインのセクションを追加（Phase 5.2実装完了）            |
| 初版       | Claude | フロントエンド技術仕様作成                                            |
