---
title: "技術仕様書：システムアーキテクチャ"
type: technical
status: active
role: TechLead
tags: [techspec, architecture, cloudflare, astro, cost-optimization]
---

# 技術仕様書：システムアーキテクチャ

> **テンプレート利用ガイド**
> システム全体のアーキテクチャ設計書です。
> **利用職種**: Architect, TechLead


## 概要
Astranoteのシステムアーキテクチャは、**維持費を最小限に抑えながら（コストファースト）**、グローバルなスケーラビリティと開発速度を両立させることを目的として設計されている。
Cloudflareプラットフォームに統一することで、CDN、Edge Computing、Database、Storageを統合的に管理し、Egressコストを削減する。

### 設計方針
- **コストファースト**: 無料枠・低コストサービス（Cloudflare D1, R2, Gemini Flash）を最大活用。
- **Cloudflare統一**: 一つのプラットフォームで完結させ、レイテンシとコストを最適化。
- **段階的スケール**: MVPは無料枠で運用し、成長に合わせて有料プランへ移行。


## システムアーキテクチャ

### アーキテクチャ構成図 (Cloudflare統一)
```mermaid
graph TD
    User[ユーザー (Web/PWA)] --> CF[Cloudflare CDN]
    CF --> Pages[Cloudflare Pages (Frontend)]
    CF --> Workers[Cloudflare Workers (Backend API)]

    subgraph Backend Services
        Workers --> D1[(Cloudflare D1 - DB)]
        Workers --> KV[(Cloudflare KV - Cache)]
        Workers --> R2[(Cloudflare R2 - Storage)]
        Workers --> AI[Translation Service]
    end

    AI --> Gemini[Gemini 2.0 Flash (低コスト)]
    AI --> Claude[Claude 3.5 Haiku (高品質)]
```

### 技術スタック
| コンポーネント | 技術 | 詳細 | 採用理由 |
|---------------|------|------|----------|
| **Frontend** | Astro | SSG/SSR | パフォーマンスとSEO最適化。アイランドアーキテクチャ。 |
| **Backend** | Cloudflare Workers | Hono | エッジでの低遅延実行、0msコールドスタート。 |
| **Language** | TypeScript | - | 前後端の型共有。 |
| **Auth** | Lucia Auth | - | 柔軟なセッション管理。 |
| **Database** | Cloudflare D1 | SQLite | エッジDB。無料枠が大きい。 |
| **Storage** | Cloudflare R2 | S3 Compatible | Egress無料。画像保存用。 |
| **AI** | Gemini 2.0 Flash | - | 圧倒的なコストパフォーマンス。 |


## コスト最適化戦略
### 翻訳機能コスト
- **メイン**: Gemini 2.0 Flash ($0.10/1M tokens) を使用し、翻訳コストを極小化。
- **補助**: DeepL Free (月50万文字) を併用。
- **プレミアム**: Claude 3.5 Sonnet を有料会員向けに提供。

### インフラコスト
- **Phase 1 (MVP)**: 月額 ~$4 (ドメイン代等のみ)。Cloudflareの無料枠内で運用。
- **Phase 2 (Growth)**: Cloudflare Workers Paid ($5) + Gemini従量課金。


## データモデル概要
- **DB**: Cloudflare D1 (SQLite)
- **検索**: D1 FTS5 (Full Text Search) を利用し、外部検索エンジン(Meilisearch等)のコストを削減。


## キャッシュ戦略
1. **Static Assets**: Cloudflare CDN (TTL: 1年)
2. **Translation**: Cloudflare KV / D1 (永続キャッシュ)
3. **Session**: Cloudflare KV (24時間)
4. **Browser**: Service Workerによるオフラインキャッシュ

## 関連ドキュメント
- [51.01_TechSpec_Frontend.md](51.01_TechSpec_Frontend.md)
- [51.01_TechSpec_Backend.md](51.01_TechSpec_Backend.md)
