---
title: 認証・認可
description: Lucia Auth による認証システム
---

Astranote では、**Lucia Auth** を使用してセキュアで柔軟な認証システムを構築します。

## 認証方式

- **セッションベース認証**: Cloudflare D1 にセッション情報を保存し、HttpOnly Cookie でセッションIDを管理します。
- **OAuth ログイン**: Google, GitHub, Discord などのソーシャルログインをサポートします。
- **メール/パスワード**: 従来のアカウント作成（ハッシュ化して保存）。

## 認証フロー

1. **ユーザー登録/ログイン**: クライアントから認証リクエスト。
2. **セッション作成**: 認証成功時、サーバーでセッションを作成し、Cookieにセット。
3. **リクエスト検証**: 保護されたAPIへのリクエスト時に、MiddlewareでCookieのセッションIDを検証。
4. **Context設定**: 検証成功時、`c.set('user', user)` でユーザー情報をコンテキストに注入。

## 権限管理 (Roles)

ユーザーには以下のロールが付与されます。

| ロール | 権限 |
| ------ | ---- |
| **Guest** | 小説の閲覧（制限あり）、ログイン |
| **Reader** | 小説の閲覧、ブックマーク、コメント、フォロー |
| **Writer** | Reader権限 + 小説の作成・編集・公開 |
| **Admin** | 全システムの管理、ユーザー管理、コンテンツ削除 |

## セキュリティ対策

- **CSRF対策**: HonoのCSRFミドルウェアを使用。
- **HttpOnly Cookie**: XSSによるセッション奪取を防止。
- **Secure Attribute**: HTTPS環境でのみCookieを送信。
